<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Blind Not Dumb - shell</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Blind Not Dumb </a></h1>
                <nav><ul>
                    <li><a href="/category/art.html">Art</a></li>
                    <li><a href="/category/book-rants.html">Book Rants</a></li>
                    <li><a href="/category/books.html">Books</a></li>
                    <li><a href="/category/food.html">Food</a></li>
                    <li><a href="/category/games.html">games</a></li>
                    <li><a href="/category/geekery.html">Geekery</a></li>
                    <li><a href="/category/misc.html">misc</a></li>
                    <li><a href="/category/music.html">Music</a></li>
                    <li><a href="/category/personal.html">Personal</a></li>
                    <li><a href="/category/politics.html">Politics</a></li>
                    <li><a href="/category/rants.html">Rants</a></li>
                    <li><a href="/category/video-games.html">Video Games</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/managing-crontabs-with-git.html">Managing crontabs with Git</a></h1>
<footer class="post-info">
        <abbr class="published" title="2010-10-20T15:24:00+02:00">
                Published: Wed 20 October 2010
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/feoh.html">feoh</a>
        </address>
<p>In <a href="/category/geekery.html">Geekery</a>. </p>
<p>tags: <a href="/tag/administration.html">administration</a> <a href="/tag/bourne-shell.html">bourne shell</a> <a href="/tag/cron.html">cron</a> <a href="/tag/crontab.html">crontab</a> <a href="/tag/git.html">Git</a> <a href="/tag/management.html">management</a> <a href="/tag/scm.html">SCM</a> <a href="/tag/script.html">script</a> <a href="/tag/shell.html">shell</a> <a href="/tag/sysadmin.html">sysadmin</a> <a href="/tag/unix.html">UNIX</a> </p>
</footer><!-- /.post-info --><p><span style="color: #0000ff;">April 2012 Update</span>: <span
style="color: #ff0000;">Nowadays we use <a href="http://www.opscode.com/chef/" title="Chef"><span
style="color: #ff0000;">Chef</span></a>
from Opscode solutions to manage our crontabs, and just about everything
else in our enterprise infrastructure. It rocks :)</span></p>
<p>Time and time again over the years I've dealt with the same problem -
who took a random pot shot at some critical user's crontab file and
deleted things without asking?</p>
<!--more-->

<p>All of a sudden, someone realizes that some function that's supposed to
run every so often has stopped, and in fact hasn't run in weeks. You
sniff around - nope, no errors in the logs, in fact no logs at all!</p>
<p>Then you look at the crontab for the user in question and realize that
the lines invoking the script that used to be there have either been
deleted or commented out. What the? Who did this, and why?</p>
<p>Git to the rescue! With the help of a simple Bourne Shell script, you
can keep your crontab managed so you'll not just be able to see who
changed what and when, but if you have the Git hook installed to send
mail on commits, you can be notified of those changes in real time.
Pretty cool eh? :)</p>
<p>Since crontab has no built in security precautions other than requiring
you to BE the user whose crontab you're submitting, we can't lock people
not using this script out, but if you tell everyone that changes they
make outside of the script may be summarily ignored and overwritten (and
put something to that effect in the comment block at the top of your
crontab) you should be in good shape. The script will compare what's in
Git with what's currently installed in cron, and if there are
discrepancies it will give you a chance to cleanly exit and resolve
them, or allow you to ignore them and roll forward with editing and
submitting what's in Git.</p>
<p>Here's the script. It assumes you're running as your regular user and
have sudo privs to the user whose crontab you wish to edit. It also
assumes you've created a Git repository called system_cron.git</p>
<p>To set it up, just edit reponame and gitrepo to appropriate values for
your site and copy the script to somewhere folks can access it in their
PATH.</p>
<p>To use it, just invoke it with the user whose crontab you want to edit -
for example:<code>edit_crontab.sh build</code></p>
<p>``` {lang="bash"}</p>
<h1>!/bin/sh</h1>
<p>export tmpdir="/tmp/crontab_$$"</p>
<p>if [ $# -lt 1 ]; then
    echo "Usage: $0 "
    exit 1;
fi</p>
<p>if [ -z "$EDITOR" ]; then
    echo "No editor found.  Using vim."
    export EDITOR="/usr/bin/vim"
fi</p>
<p>crontab_user=$1</p>
<p>crontab_file="<code>uname -n</code>-$crontab_user.crontab"
echo "crontab_file=$crontab_file"</p>
<p>git clone /home/git/system_cron.git $tmpdir
cd $tmpdir</p>
<p>sudo -u $crontab_user crontab -l &gt; currcrontab_$$</p>
<p>if [ $? -ne 0 ]; then
    echo "sudo to user $crontab_user failed! Do you have sudo privs?"
    exit 1;
fi</p>
<p>diff=<code>diff currcrontab_$$ $crontab_file</code></p>
<p>if [ $? -ne 0 ]; then
    echo "Currently running crontab for $crontab_user differs from Git!"
    echo "Here are the differences:"
    echo $diff
    echo 
    echo -n "Continue editing / submitting what's in Git? (Y/n): "
    read yesorno
    if [ "$yesorno" != "Y" ]; then
        echo "Very good.  Exiting." 
        exit 1;      <br />
    fi
fi</p>
<p>$EDITOR $crontab_file</p>
<p>echo "Here are your changes:"
git diff --exit-code $crontab_file
if [ $? -eq 0 ]; then
    echo "No changes made.  Not submitting anything."
    exit 1;
fi</p>
<p>echo -n "Submit these changes to Git and crontab? (Y/n): "
read yesorno
if [ "$yesorno" != "Y" ]; then
    echo "Your changes are in $tmpdir/system_cron/$crontab_file."
    echo "Please clean up this directory when you're done with it."
    exit 1;      <br />
else
    git commit $crontab_file
    if [ $? -ne 0 ]; then
        echo "There was a problem committing your crontab to git!"
        exit 1;
    fi
    git push origin master
    if [ $? -ne 0 ]; then
        echo "There was a problem pushing your crontab to git!"
        exit 1;
    fi</p>
<div class="highlight"><pre><span class="err">#</span><span class="x"> if we made it this far. We&#39;re all good.  Install that puppy!</span>

<span class="x">echo &quot;Installing your crontab.&quot;</span>
<span class="x">sudo -u </span><span class="p">$</span><span class="nv">crontab_user</span><span class="x"> crontab </span><span class="p">$</span><span class="nv">crontab_file</span><span class="x"></span>
<span class="x">if [ </span><span class="p">$</span><span class="x">? -ne 0 ]; then</span>
<span class="x">    echo &quot;ERROR! Your changes were NOT installed! Something went wrong.&quot;</span>
<span class="x">    exit 1;</span>
<span class="x">fi</span>
</pre></div>


<p>fi</p>
<p>echo "Cleaning up tmp directory..."</p>
<h1>rm -rf $tmpdir</h1>
<p>```</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                            <li><a href="#">You can modify those links in your config file</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="#">You can add links in your config file</a></li>
                            <li><a href="#">Another social link</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>